<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florer√≠a Orlandito - Cat√°logo Digital</title>
    
    <link rel="icon" href="img/icono-flor.png" type="image/png">
    
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=MXN"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>üå∫ Florer√≠a Orlandito</h1>
                </div>
                <div class="contact-info">
                    <p>üìû Tel: 55 1160 6332</p>
                    <p>üìç Central de Abastos, Ayotla, Ixtapaluca</p>
                </div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="hero-content">
            <h2>Flores que Expresan Emociones</h2>
            <p>Arreglos florales, frutales y detalles personalizados para cada ocasi√≥n especial</p>
            <a href="#catalogo" class="btn">Ver Cat√°logo</a>
        </div>
    </section>

    <section class="catalog" id="catalogo">
        <div class="container">
            <h2 class="section-title">Nuestro Cat√°logo</h2>
            
            <div class="categories">
                <button class="category-btn active" data-category="all">Todos</button>
                <button class="category-btn" data-category="ramos">Ramos</button>
                <button class="category-btn" data-category="arreglos">Arreglos Especiales</button>
                <button class="category-btn" data-category="frutales">Arreglos Frutales</button>
                <button class="category-btn" data-category="ocasion">Por Ocasi√≥n</button>
            </div>
            
            <div class="products">
                <div class="product-card" data-category="ramos">
                    <img src="img/rosas.jpg" alt="Ramo de Rosas Rojas" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Ramo de Rosas Rojas</h3>
                        <p class="product-price">$350</p>
                        <p class="product-description">Hermoso ramo de 12 rosas rojas, perfecto para expresar amor y pasi√≥n.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(1,'Ramo de Rosas Rojas', 350)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
                
                <div class="product-card" data-category="arreglos">
                    <img src="img/centro.jpg" alt="Centro de Mesa Elegante" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Centro de Mesa Elegante</h3>
                        <p class="product-price">$550</p>
                        <p class="product-description">Elegante centro de mesa con flores de temporada, ideal para eventos especiales.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(2,'Centro de Mesa Elegante', 550)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
                
                <div class="product-card" data-category="frutales">
                    <img src="img/frutal.jpeg" alt="Canasta Frutal Especial" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Canasta Frutal Especial</h3>
                        <p class="product-price">$480</p>
                        <p class="product-description">Deliciosa combinaci√≥n de frutas de temporada en un arreglo especial para regalar.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(3,'Canasta Frutal Especial', 480)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
                
                <div class="product-card" data-category="ramos">
                    <img src="img/mixto.jpg" alt="Ramo Mixto de Temporada" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Ramo Mixto de Temporada</h3>
                        <p class="product-price">$320</p>
                        <p class="product-description">Colorido ramo con variedad de flores de temporada, perfecto para cualquier ocasi√≥n.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(4,'Ramo Mixto de Temporada', 320)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
                
                <div class="product-card" data-category="ocasion">
                    <img src="img/aniversario.jpg" alt="Arreglo para Aniversario" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Arreglo para Aniversario</h3>
                        <p class="product-price">$420</p>
                        <p class="product-description">Especialmente dise√±ado para celebrar aniversarios, con flores que simbolizan amor duradero.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(5,'Arreglo para Aniversario', 420)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
                
                <div class="product-card" data-category="ocasion">
                    <img src="img/cumplea√±os.jpg" alt="Ramo para Cumplea√±os" class="product-img">
                    <div class="product-info">
                        <h3 class="product-title">Ramo para Cumplea√±os</h3>
                        <p class="product-price">$380</p>
                        <p class="product-description">Colorido y festivo, perfecto para celebrar un d√≠a especial con alegr√≠a y color.</p>
                        <button class="btn add-btn" onclick="agregarAlCarrito(6,'Ramo para Cumplea√±os', 380)">
                            Agregar al Carrito üõí
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Florer√≠a Orlandito</h3>
                    <p>"Flores que transmiten emociones y sentimientos especiales"</p>
                    <p>üìç Central de Abastos, Ayotla, Ixtapaluca, Estado de M√©xico</p>
                </div>
                
                <div class="footer-section">
                    <h3>Horarios de Atenci√≥n</h3>
                    <p>Lunes a S√°bado: 8:00 am - 8:00 pm</p>
                    <p>Domingo: 9:00 am - 6:00 pm</p>
                </div>
                
                <div class="footer-section">
                    <h3>Cont√°ctanos</h3>
                    <p>üìû Tel: 55 1160 6332</p>
                    <div class="social-links">
                        <a href="https://www.facebook.com/share/1JPnqKKDWf/" target="_blank">üìò Facebook</a>
                    </div>
                    <div>
                        <a href="https://wa.me/525511606332" target="_blank">üì± WhatsApp</a>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025 Florer√≠a Orlandito - Todos los derechos reservados</p>
            </div>
        </div>
    </footer>

    <div class="cart-icon" id="cartIcon">
        üõí <span id="cartCount">0</span>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h3>Tu Pedido üå∫</h3>
                <span class="close-cart" id="closeCart">&times;</span>
            </div>
            
            <div class="cart-items" id="cartItems">
                <p class="empty-msg">Tu carrito est√° vac√≠o</p>
            </div>

            <div class="cart-footer">
                <div class="total-row">
                    <span>Total:</span>
                    <span>$<span id="cartTotal">0</span></span>
                </div>
                
                <div id="paypal-button-container"></div>

                <button id="btnImprimirTicket" class="btn-cash" onclick="generarTicket()">
                    Pago en Efectivo
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let carrito = [];

        // --- 1. MODIFICAR: Ahora recibimos el ID ---
        function agregarAlCarrito(id, nombre, precio) {
            // Guardamos el ID, nombre y precio
            carrito.push({ id: id, nombre: nombre, precio: precio });
            actualizarCarritoUI();
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "¬°Agregado! ‚úÖ";
            btn.style.backgroundColor = "#1b5e20";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = ""; 
            }, 1000);
        }

        function eliminarItem(index) {
            carrito.splice(index, 1);
            actualizarCarritoUI();
        }

        function obtenerTotal() {
            return carrito.reduce((sum, item) => sum + item.precio, 0);
        }

        function actualizarCarritoUI() {
            const itemsContainer = document.getElementById('cartItems');
            const totalElement = document.getElementById('cartTotal');
            const countElement = document.getElementById('cartCount');
            const paypalContainer = document.getElementById('paypal-button-container');
            const btnTicket = document.getElementById('btnImprimirTicket');
            
            itemsContainer.innerHTML = '';
            let total = obtenerTotal();

            if (carrito.length === 0) {
                itemsContainer.innerHTML = '<p class="empty-msg">Tu carrito est√° vac√≠o ü•Ä</p>';
                paypalContainer.style.display = 'none';
                btnTicket.style.display = 'none';
            } else {
                paypalContainer.style.display = 'block';
                btnTicket.style.display = 'flex';
                
                carrito.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = `
                        <span style="flex-grow:1">${item.nombre}</span>
                        <span style="color:#e91e63; font-weight:bold; margin:0 10px">$${item.precio}</span>
                        <button onclick="eliminarItem(${index})" style="border:none; background:none; cursor:pointer; font-size:18px">üóëÔ∏è</button>
                    `;
                    itemsContainer.appendChild(div);
                });
            }

            totalElement.innerText = total;
            countElement.innerText = carrito.length;
        }

        // --- NUEVO: Funci√≥n para enviar datos a PHP y descontar stock ---
        async function procesarStockEnBD() {
            try {
                const datos = new FormData();
                datos.append('productos_comprados', JSON.stringify(carrito));

                const respuesta = await fetch('procesar_compra.php', {
                    method: 'POST',
                    body: datos
                });

                const resultado = await respuesta.json();
                
                if (resultado.success) {
                    console.log("Stock actualizado correctamente");
                    return true;
                } else {
                    alert("Error actualizando inventario: " + resultado.message);
                    return false;
                }
            } catch (error) {
                console.error("Error de red:", error);
                return false;
            }
        }

        // --- PAYPAL CONFIG ---
        paypal.Buttons({
            fundingSource: paypal.FUNDING.PAYPAL,
            style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },

            createOrder: function(data, actions) {
                let totalActual = obtenerTotal();
                if (totalActual === 0) return;
                return actions.order.create({
                    purchase_units: [{
                        amount: { value: totalActual },
                        description: "Compra en Florer√≠a Orlandito"
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(async function(details) {
                    // 1. Primero descontamos el stock
                    await procesarStockEnBD();
                    
                    // 2. Luego mostramos √©xito
                    alert('¬°Pago completado por ' + details.payer.name.given_name + '! Gracias.');
                    carrito = [];
                    actualizarCarritoUI();
                    document.getElementById('cartModal').style.display = 'none';
                });
            },
            onError: function (err) {
                console.error(err);
                alert("Error con PayPal.");
            }
        }).render('#paypal-button-container');

        // --- TICKET (EFECTIVO) ---
        // --- TICKET (EFECTIVO) ---
async function generarTicket() {
    if (carrito.length === 0) return alert("El carrito est√° vac√≠o.");

    // PASO 1: Intentar descontar el stock en la BD
    // La palabra 'await' hace que el c√≥digo espere a que PHP responda antes de seguir
    const stockActualizado = await procesarStockEnBD();
    
    // Si hubo error en la BD, detenemos todo y NO imprimimos ticket
    if (!stockActualizado) return; 

    // PASO 2: Si el stock se actualiz√≥ bien, generamos el ticket visual
    const total = obtenerTotal();
    const fecha = new Date().toLocaleDateString();
    const hora = new Date().toLocaleTimeString();
    const folio = Math.floor(Math.random() * 10000) + 1000;

    let ticketContent = `
        <html>
        <head>
            <title>Ticket de Compra - Florer√≠a Orlandito</title>
            <style>
                body { font-family: 'Courier New', Courier, monospace; width: 300px; margin: 0 auto; padding: 10px; }
                .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                h2 { margin: 5px 0; font-size: 18px; }
                .info { font-size: 12px; margin-bottom: 10px; text-align: center; }
                .table { width: 100%; font-size: 12px; }
                .table th { text-align: left; border-bottom: 1px solid #000; }
                .total-row { border-top: 2px solid #000; font-weight: bold; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between; }
                .footer { margin-top: 20px; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 10px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>üå∫ Florer√≠a Orlandito</h2>
                <div class="info">
                    <p>Central de Abastos, Ayotla</p>
                    <p>Folio: #${folio}</p>
                    <p>${fecha} - ${hora}</p>
                </div>
            </div>
            <table class="table">
                <thead><tr><th>CANT.</th><th>DESC.</th><th>$$</th></tr></thead>
                <tbody>
    `;

    carrito.forEach(item => {
        ticketContent += `<tr><td>1</td><td>${item.nombre}</td><td>$${item.precio}</td></tr>`;
    });

    ticketContent += `
                </tbody>
            </table>
            <div class="total-row"><span>TOTAL:</span><span>$${total}.00</span></div>
            <div class="footer"><p>¬°Gracias por su compra!</p><p>*** PAGO EN EFECTIVO ***</p></div>
            <script>window.print();<\/script>
        </body>
        </html>
    `;

    // Limpiar carrito y cerrar modal
    carrito = [];
    actualizarCarritoUI();
    document.getElementById('cartModal').style.display = 'none';

    const ventana = window.open('', 'IMPRIMIR', 'height=600,width=400');
    ventana.document.write(ticketContent);
    ventana.document.close();
}

        // --- EVENTOS DE INTERFAZ (IGUAL QUE ANTES) ---
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('cartModal');
            document.getElementById('cartIcon').addEventListener('click', () => modal.style.display = 'flex');
            document.getElementById('closeCart').addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });

            const categoryButtons = document.querySelectorAll('.category-btn');
            const productCards = document.querySelectorAll('.product-card');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.getAttribute('data-category');
                    productCards.forEach(card => {
                        card.style.display = (category === 'all' || card.getAttribute('data-category') === category) ? 'block' : 'none';
                    });
                });
            });
            actualizarCarritoUI();
        });
    </script>
</body>
</html>